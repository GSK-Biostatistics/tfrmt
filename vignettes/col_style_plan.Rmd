---
title: "Column Style Plan"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Column Style Plan}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message = FALSE, warning = FALSE}
library(tfrmt)
library(tibble)
library(dplyr)
```

tfrmt offers the ability to align value and set column widths. Columns can be aligned in the following ways:

- Left-align
- Right-align
- Align on one or more single characters (e.g., decimal alignment)

Column widths are set as either the number of pixels wide they are, or the percentage of the total table with.

Alignment and width is specified via the `col_style_plan`, which accepts a series of `element_col`s as inputs. Note that the `col_style_plan` does not have any `*_structure` objects as inputs, as `*_structure`s are for modifying the *contents* (i.e., text) of the table, while `element_*`s are for modifying *aesthetics*. 

Alignment is achieved by padding the values with character spaces; this padding ensures that alignment is robust and agnostic to the output format. Width is done during post-processing and creation of the table output.

## Element Style

`element_col` has three arguments: the columns in the final table to be aligned,
the alignment desired, the widths to apply to those columns. In each element, only one of the who (alignment, width), must be applied. Optionally both can be assigned too.

The column values that are specified are to match the contents of the `column` variable that is specified in the `tfrmt` object. When multiple values are provided to `column`, the last value is used as the reference column.

When the `col_style_plan()` is applied to the data, the most recent alignment and width is applied to the data, so be careful when adding new `element_col`'s, as the output may change more than anticipated if the new element is not specific enough. 

## Alignment

### Alignment Examples

Let's take a look at how alignment can be applied to the example below, which contains a variety of different parameters which are formatted differently. 
```{r echo = FALSE}

dat <- tribble(
  ~label     , ~param, ~column    , ~ value,   ~ord, 
  "n"        ,"n"     , "trt1"     ,12,        1, 
  "mean (sd)","mean"  , "trt1"     ,12.332837, 2,
  "mean (sd)","sd"    , "trt1"     ,4.3454547, 2,
  "median"   ,"median", "trt1"     ,14,        3, 
  "[q1, q3]" ,"q1"    , "trt1"     ,10,        4,
  "[q1, q3]" ,"q3"    , "trt1"     ,20,        4,
  "n"        ,"n"     , "trt2"     ,24,        1,
  "mean (sd)","mean"  , "trt2"     ,15.438737, 2,
  "mean (sd)","sd"    , "trt2"     ,6.723827,  2, 
  "median"   ,"median", "trt2"     ,16,        3, 
  "[q1, q3]" ,"q1"    , "trt2"     ,11,        4, 
  "[q1, q3]" ,"q3"    , "trt2"     ,22,        4,
  "n"        ,"pval"  , "p-value"  ,NA,        1, 
  "mean (sd)","pval"  , "p-value"  ,0.00002,   2, 
  "median"   ,"pval"  , "p-value"  ,0.051211,  3, 
  "[q1, q3]" ,"pval"  , "p-value"  ,NA,        4)
```

```{r}
head(dat)

tfrmt(
  label = label,
  column = column,
  param = param,
  value = value,
  sorting_cols = c(ord),
  col_plan = col_plan(-ord), 
  body_plan = body_plan(
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt("xx", missing = " ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt_combine("{mean} ({sd})", 
                                mean = frmt("xx.x"), 
                                sd = frmt("xx.xx"),
                                missing=" ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt_combine("[{q1}, {q3}]", 
                                q1 = frmt("xx.x"), 
                                q3 = frmt("xx.x"),
                                missing=" ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   pval = frmt_when(">0.99" ~ ">0.99",
                                    "<0.001" ~ "<0.001",
                                    "<0.05" ~ frmt("x.xxx*"),
                                    TRUE ~ frmt("x.xxx", missing = "")))
  )
) %>% 
  print_to_gt(dat)
```

Column alignment can improve this table by making it easier to read. Let's start by left-aligning our p-value column. Notice that by providing a `col_style_plan`, any variables that are not covered in the plan will be left-aligned by default.

```{r}
tfrmt(
  label = label,
  column = column,
  param = param,
  value = value,
  sorting_cols = c(ord),
  col_plan = col_plan(-ord), 
  body_plan = body_plan(
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt("xx", missing = " ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt_combine("{mean} ({sd})", 
                                mean = frmt("xx.x"), 
                                sd = frmt("xx.xx"),
                                missing=" ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt_combine("[{q1}, {q3}]", 
                                q1 = frmt("xx.x"), 
                                q3 = frmt("xx.x"),
                                missing=" ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   pval = frmt_when(">0.99" ~ ">0.99",
                                    "<0.001" ~ "<0.001",
                                    "<0.05" ~ frmt("x.xxx*"),
                                    TRUE ~ frmt("x.xxx", missing = "")))
  ), 
  col_style_plan =  col_style_plan(
    element_col(align = "left", col = `p-value`))
  ) %>% 
  print_to_gt(dat)
```


This alignment isn't quite right as we have the `<` in one value but not the other. Applying a decimal alignment would be a better fit:

```{r}
tfrmt(
  label = label,
  column = column,
  param = param,
  value = value,
  sorting_cols = c(ord),
  col_plan = col_plan(-ord), 
  body_plan = body_plan(
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt("xx", missing = " ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt_combine("{mean} ({sd})", 
                                mean = frmt("xx.x"), 
                                sd = frmt("xx.xx"),
                                missing=" ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt_combine("[{q1}, {q3}]", 
                                q1 = frmt("xx.x"), 
                                q3 = frmt("xx.x"),
                                missing=" ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   pval = frmt_when(">0.99" ~ ">0.99",
                                    "<0.001" ~ "<0.001",
                                    "<0.05" ~ frmt("x.xxx*"),
                                    TRUE ~ frmt("x.xxx", missing = "")))
  ), 
  col_style_plan =  col_style_plan(
    element_col(align = c("."), col = `p-value`))
  ) %>% 
  print_to_gt(dat)
```

For our other two columns, we have a mix of values represented. In this case, we want to align on the first set of digits. In other words, we will align on the first instance of a decimal, comma, or space:

```{r}
tfrmt(
  label = label,
  column = column,
  param = param,
  value = value,
  sorting_cols = c(ord),
  col_plan = col_plan(-ord), 
  body_plan = body_plan(
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt("xx", missing = " ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt_combine("{mean} ({sd})", 
                                mean = frmt("xx.x"), 
                                sd = frmt("xx.xx"),
                                missing=" ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt_combine("[{q1}, {q3}]", 
                                q1 = frmt("xx.x"), 
                                q3 = frmt("xx.x"),
                                missing=" ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   pval = frmt_when(">0.99" ~ ">0.99",
                                    "<0.001" ~ "<0.001",
                                    "<0.05" ~ frmt("x.xxx*"),
                                    TRUE ~ frmt("x.xxx", missing = "")))
  ), 
  col_style_plan =  col_style_plan(
    element_col(align = c("."), col = `p-value`),
    element_col(align = c(".", ",", " "), col = vars(starts_with("trt"))))
  ) %>% 
  print_to_gt(dat)
```


Finally, for the purpose of demonstrating our options, we can align each column differently (left, right, character for the three columns respectively):
```{r}
tfrmt(
  label = label,
  column = column,
  param = param,
  value = value,
  sorting_cols = c(ord),
  col_plan = col_plan(-ord), 
  body_plan = body_plan(
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt("xx", missing = " ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt_combine("{mean} ({sd})", 
                                mean = frmt("xx.x"), 
                                sd = frmt("xx.xx"),
                                missing=" ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt_combine("[{q1}, {q3}]", 
                                q1 = frmt("xx.x"), 
                                q3 = frmt("xx.x"),
                                missing=" ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   pval = frmt_when(">0.99" ~ ">0.99",
                                    "<0.001" ~ "<0.001",
                                    "<0.05" ~ frmt("x.xxx*"),
                                    TRUE ~ frmt("x.xxx", missing = "")))
  ), 
  col_style_plan =  col_style_plan(
    element_col(align = c("."), col = `p-value`),
    element_col(align = "left", col = trt1),
    element_col(align = "right", col = trt2))
  ) %>% 
  print_to_gt(dat)
```

### Alignment of group and label columns

At this time, group and label columns will be left aligned by default. The user can adjust the alignment of these columns through gt directly.

### Alignment via `body_plan`

It should be noted that in simple cases, the user can achieve desired alignment via the `frmt`s in the `body_plan`. These `frmt` specifications  allow us to pad values to a desired length. For example, `frmt(xxx)` will ensure values with fewer than 3 digits will be padded accordingly: 23 will become " 23" and 9 will become "  9". In a straightforward table of values with similar scales, this may be sufficient. However in many cases the user may desire more control over alignment and the `col_style_plan` is the preferred method. 

## Width

Width is either set to a specific value in number of pixels or a percentage of the total table width. These values are specified by passing a character value to the "width" argument of `element_col`, taking the format of "##px" or "##%", where "##" is the number of pixels or percent. "px" indicates the width in pixels, and "%" indicates the width is a percent of the total table width. 

Width can be applied to any of the columns in the table.

### Example

Continuing the example from alignment, we set the widths of the columns in the table.
Because "label" is output in the table, we can apply the widths to that column as well.

```{r}
tfrmt(
  label = label,
  column = column,
  param = param,
  value = value,
  sorting_cols = c(ord),
  col_plan = col_plan(-ord), 
  body_plan = body_plan(
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt("xx", missing = " ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt_combine("{mean} ({sd})", 
                                mean = frmt("xx.x"), 
                                sd = frmt("xx.xx"),
                                missing=" ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   frmt_combine("[{q1}, {q3}]", 
                                q1 = frmt("xx.x"), 
                                q3 = frmt("xx.x"),
                                missing=" ")),
    frmt_structure(group_val = ".default", label_val = ".default", 
                   pval = frmt_when(">0.99" ~ ">0.99",
                                    "<0.001" ~ "<0.001",
                                    "<0.05" ~ frmt("x.xxx*"),
                                    TRUE ~ frmt("x.xxx", missing = "")))
  ), 
  col_style_plan =  col_style_plan(
    element_col(width = "300px", col = label),
    element_col(align = c("."), width = "100px", col = `p-value`),
    element_col(align = "left", width = "250px", col = trt1),
    element_col(align = "right", width = "250px", col = trt2))
  ) %>% 
  print_to_gt(dat)

```
