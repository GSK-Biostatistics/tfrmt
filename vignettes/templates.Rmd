---
title: "Creating Template tfrmts"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating Template tfrmts}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tlang)
library(dplyr)
library(gt)
library(tidyr)
```

A core design element of `tlang` is to offer the ability to layer tfrmts together. This ability provides an opportunity for organizations to build template table formats that can be shared, improved, and reused across multiple projects. Through layering the users can customize the templates to create a specific table. 

The creation of a template is based on the standard development of a `tfrmt`, but wrapping its creation into a function. using the `layer_tfrmt` function. We will go through their applications below.  

## Creating a standard tfrmt

A template is based around creating a standard `tfrmt`, and then writing a function around it to provide the ability to layer multiple templates. 

We will create an Adverse Events table template in this example. This requires there to be some standards that can be expected that allows the construction of the basic `tfrmt`:

First, we can provide instructions on cell formatting via the `body_plan`. We know that the cells should be consistently formatted as follows:

  - Total counts should be whole numbers 
  - Cells within each treatment group column should be a combination of a count and percent of that population. When percent is 100 or zero, value should be blank.
  - p-values should be formatted where: >.99 is displayed as ">0.99", <0.001 is displayed as "<0.001", and any values between should be displayed to three decimal places. Missing p-values should be replaced with "--".
  
Next, because our data is standardized as an analysis results dataset, we can pre-fill the expected column names. This also ensures that the data abides to the standard and names are set consistently:

  - `AEBODYSYS` defines the body systems and overall grouping of the data.
  - `AETERM` defines the labels to display in the table.
  - `value` defines the values to present in the table.
  - `treatment` defines the treatments and column for each value.
  - `param` is the column that describes the params of the `value` column. "AEs" indicates that the number in `value` represents the total counts, "n" represents the count for the specific AE, "pct" is the percent of the treatment population, and finally "pval" is the p-value.
  
With this information we can construct a template AE `tfrmt`:
  
```{r}

ae_tfrmt_template <- tfrmt(
    group = AEBODSYS,
    label = AETERM,
    param = param,
    column = treatment,
    value = value,
  body_plan = body_plan(
    ## All entries where the param column is `AEs` (representing total counts)
    frmt_structure(
      group_val = ".default",
      label_val = ".default",
      AEs = frmt("[XXX]")
      ),
    
    ## Combine entries where param column is `n` and `pct` to create a cell for
    ## that population
    frmt_structure(
      group_val = ".default",
      label_val = ".default",
      frmt_combine(
        "{n} {pct}",
        n = frmt("XXX"),
        pct = frmt_when(
          "==100" ~ "",
          "==0" ~ "",
          TRUE ~ frmt("(xx.x %)")
          )
        )
      ),
    
    ## All entries where param column is `pval`, format conditionally.
    ## When the value is missing, replace the NA with "--".
    frmt_structure(
       group_val = ".default", 
       label_val = ".default",
       pval = frmt_when(
         ">0.99" ~ ">0.99",
         "<0.001" ~ "<0.001",
         TRUE ~ frmt("x.xxx", missing = "--")
         )
    )
  )
)


```

## Functionalizing the template

This is where we turn to using functions to define a template. This allows us to have as many layers as we'd like. For example, we can have an organization-level template to be used across all tables, a domain-level template to be used across all tables in a given domain, and a project-level template to be used for study-specific tables. 

`tlang` offers the function `layer_tfrmt()`, which provides the ability for layering `tfrmt` together. The first two arguments are the `tfrmt` objects to be layered. By default the body_plans of the tfrmt are joined together.

See below for an example of creating a template based on a function for layering `tfrmt` together. In this scenario the base AE template only has body_plan values for handling total counts, case counts, and percents, but not pvalues. We create another template for pvalues, and then finally layer it with the study specific tfrmt.

```{r}

ae_base_tfrmt_template <- function(tfrmt_obj = NULL){
  
  ae_layer <- tfrmt(
    group = AEBODSYS,
    label = AETERM,
    param = param,
    column = treatment,
    value = value,
    body_plan = body_plan(
      ## All entries where the param column is `AEs` (representing total counts)
      frmt_structure(
        group_val = ".default",
        label_val = ".default",
        AEs = frmt("[XXX]")
        ),
      
      ## Combine entries where param column is `n` and `pct` to create a cell for
      ## that population
      frmt_structure(
        group_val = ".default",
        label_val = ".default",
        frmt_combine(
          "{n} {pct}",
          n = frmt("XXX"),
          pct = frmt_when(
            "==100" ~ "",
            "==0" ~ "",
            TRUE ~ frmt("(xx.x %)")
            )
          )
        )
    )
  )
  
  if(!is.null(tfrmt_obj)){
    ae_layer <- layer_tfrmt(tfrmt_obj, ae_layer)
  }
  
  ae_layer
  
}


ae_pval_tfrmt_template <- function(tfrmt_obj){
  
  ae_pval_template <- tfrmt(
    body_plan = body_plan(
      ## All entries where param column is `pval`, format conditionally.
      ## When the value is missing, replace the NA with "--".
      frmt_structure(
         group_val = ".default", 
         label_val = ".default",
         pval = frmt_when(
           ">0.99" ~ ">0.99",
           "<0.001" ~ "<0.001",
           TRUE ~ frmt("x.xxx", missing = "--")
           )
      )
    )
  )
  
  if(!is.null(tfrmt_obj)){
    ae_pval_template <- layer_tfrmt(tfrmt_obj, ae_pval_template)
  }
  
  ae_pval_template
  
}

```

Using these templates and what we learned from the layering vignette, we can apply multiple templates cleanly within a pipe:

```{r}

study_ae_tfrmt_multi_layer <- ae_base_tfrmt_template() %>% 
  ae_pval_tfrmt_template() %>% 
  tfrmt(
    title = "Adverse Events for CDISC Pilot Study",
    subtitle = "Data subset to AEs with >10% prevalence in the High Dose group",
    
    ## Sorting columns of rows
    sorting_cols = c(ord1, ord2),
    
    ## Nest Preferred terms under SOC
    row_grp_plan = row_grp_plan(label_loc = element_row_grp_loc(location = "indented")),
    
    ## alisgnment of columns
    col_align = col_align_plan(
      element_align(align = c(".",","," "), col = vars(starts_with("p_")))
    ),
    
    ## remove order columns from final table
    col_plan = col_plan(
      -ord1,-ord2,
      span_structure(
        "Xanomeline High Dose (N=84)",
        `n (%)` = `Xanomeline High Dose-n_pct` ,
        `[AEs]` = `Xanomeline High Dose-AEs`
      ),
      span_structure(
        "Xanomeline Low Dose (N=84)",
        `n (%)` = `Xanomeline Low Dose-n_pct` ,
        `[AEs]` = `Xanomeline Low Dose-AEs`
      ),
      span_structure("Placebo (N=86)",
                     `n (%)` = `Placebo-n_pct` ,
                     `[AEs]` = `Placebo-AEs`),
      span_structure(
        "Fisher's Exact p-values",
        `Placebo vs. Low Dose` = `fisher_pval-p_low` ,
        `Placebo vs. High Dose` = `fisher_pval-p_high`
      )
    )
  )


```

See how this results in the same table as above:

```{r}

## filter to keep only AEs with >10% prevalence in the High Dose group
ae_data2 <- ae_data %>% 
  group_by(AEBODSYS, AETERM) %>% 
  mutate(pct_high = value[col2=="Xanomeline High Dose" & param=="pct"]) %>% 
  ungroup %>% 
  filter(pct_high >10) %>% 
  select(-pct_high) %>% 
  unite("treatment", c(col2, col1), sep = "-")

study_ae_tfrmt_multi_layer %>% 
  print_to_gt(ae_data2) %>% 
  tab_options(
    container.width = 1000
  )

```
