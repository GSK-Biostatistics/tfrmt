---
title: "ARD"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ARD}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
library(tfrmt)
library(cards)
library(dplyr)
library(tidyr)
library(pharmaverseadam)
library(gt)
```

# How to prepare input ARD

### What is an ARD?

An **Analysis Results Data (ARD)** provides statistical analysis results in a structured, machine-readable format. It provides a way to store analysis outcomes in a consistent manner, making it easier to reuse and integrate those results into reports, tables, and figures.

### Key Features of an ARD

-   **Structured Data**: The ARD format organizes statistical results, ensuring they are easily interpreted and accessible for further analysis.

-   **Reusability**: Once created, an ARD can be reused for future reporting needs, eliminating the need for repetitive data processing.

-   **No Layout Description**: The ARD focuses on the data itself, not on the visual layout of tables or figures. This means you can use the data to generate reports in various formats.

### How to Create an ARD

We recommend using the **cards** package to create your ARDs. For more details, visit the [cards documentation](https://insightsengineering.github.io/cards/latest-tag/index.html).

If youâ€™re new to ARDs or the cards package, check out [ARDs and Cards Workshop Notes](https://www.danieldsjoberg.com/ARD-RinPharma-workshop-2024/slides/01-intro-cards/#/title-slide).

For information on the **Analysis Results Standard (ARS)**, visit this [CDISC Webinar on ARS](https://www.cdisc.org/events/webinar/analysis-results-standard-public-review).

## Dataset Structure and Column Requirements

We expect a long-format dataset, with one record per computed value.

Required columns are as follows:

-   **[Optional] Grouping columns**: One or more columns containing grouping values.

-   **Label column**: A single column containing row label values.

-   **Column value columns**: One or more columns containing the values for each column in your dataset.

-   **Param column**: A single column that labels distinct types of values.

-   **Value column**: A single column containing the computed raw data values.

-   **[Optional] Sorting columns**: One or more columns with numeric values to control row ordering.

### Additional Requirements

-   Ensure all values in the `value` column are unformatted and type numeric.

-   Structure is 1 record per unique results value.

-   Include distinct columns for each grouping variable.

-   Ensure that all relevant information, particularly labels, is included.

## Example: Using the **cards** package to create an ARD in the correct format for **tfrmt**

```{r, message=FALSE}
# Demographic summaries using {cards}

# In this example we create demographic summaries by treatment group (TRT01A)

#  Set up
## Load necessary packages
library(cards)

## Load ADaM ADSL data
adsl <- pharmaverseadam::adsl |> 
       dplyr::filter(SAFFL == "Y")

# Example 1
#  Simple example Using `ard_stack()` helper to calculate combined results in 1 step
ard_full_simple <- ard_stack(
  data = adsl,
  .by = TRT01A,
  ard_continuous(variables = AGE)
)

print(ard_full_simple)


# Manipulations to prep for display

ard_demog_simple <- ard_full_simple |>
  #Rename the grouping and variable columns to their original column names.
  rename_ard_columns(columns = c("group1")) |> 
  unlist_ard_columns() |>
  #Fill in any overall summaries with TRT01A = "Overall"
  replace_na(list(TRT01A = "Overall")) |>
  #Add unique stat names for big N's 
  mutate(
    stat_name = ifelse(
      variable == "TRT01A" & stat_name == "n",
      "bigN",
      stat_name
    )
  ) |>
    # remove unneeded stats
  filter(!(variable=="TRT01A" & stat_name !="bigN")) 

print(ard_demog_simple)

# Example 2
##  more detailed example using ard_continuous and ard_categorical
ard_full <- ard_stack(
  data = adsl,
  .by = TRT01A,
  ard_continuous(variables = AGE),
  ard_categorical(variables = c(AGEGR1,SEX,RACE,ETHNIC))
)

print(ard_full)

# Manipulations to prep for display
#  - Fill in any overall summaries with TRT01A = "Overall"
#  - Add columns to order on
#  - keep only treatment group big N's (not variable-level Ns)
ard_demog <- ard_full |>
   #Rename the grouping and variable columns to their original column names.
  rename_ard_columns(columns = c("group1")) |> 
  unlist_ard_columns() |>
  replace_na(list(TRT01A = "Overall")) |>
  mutate(
    stat_name = ifelse(
      variable == "TRT01A" & stat_name == "n",
      "bigN",
      stat_name
    ),
    ord1 = as.numeric(factor(
      variable,
      levels = c(
        "AGE",
        "AGEGR1",
        "SEX",
        "RACE",
        "ETHNIC"
      )
    )),
    ord2 = as.numeric(factor(variable_level, levels = c("18-64", ">64")))
  ) |>
  filter(!(variable=="TRT01A" & stat_name !="bigN"))

print(ard_demog)
```
